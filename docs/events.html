<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>OVO Comms Platform</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="comms-platform" /><meta name="author" content="Comms team" /><meta name="og:image" content="/comms-platform/img/poster.png" /><meta name="og:title" content="OVO Comms Platform" /><meta name="og:site_name" content="OVO Comms Platform" /><meta name="og:url" content="https://ovoenergy.slack.com/messages/hello_comms/" /><meta name="og:type" content="website" /><meta name="og:description" content="comms-platform" /><meta name="twitter:image" content="/comms-platform/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><link rel="icon" type="image/png" href="/comms-platform/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/comms-platform/highlight/styles/default.css" /><link rel="stylesheet" href="/comms-platform/css/style.css" /><link rel="stylesheet" href="/comms-platform/css/palette.css" /><link rel="stylesheet" href="/comms-platform/css/home.css" /><link rel="stylesheet" href="/comms-platform/css/docs.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/comms-platform/" class="brand"><div class="brand-wrapper" style="background:url('/comms-platform/img/sidebar_brand.png') no-repeat"><span>OVO Comms Platform</span></div></a></li> <li><a href="/comms-platform/docs/index.html" class="">Getting Started</a></li> <li><a href="/comms-platform/docs/news.html" class="">News & Updates</a></li> <li><a href="/comms-platform/docs/templates.html" class="">Templates</a> <ul class="sub_section"> <li><a href="/comms-platform/docs/templates/email.html" class="">Email</a></li> <li><a href="/comms-platform/docs/templates/sms.html" class="">SMS</a></li> <li><a href="/comms-platform/docs/templates/print.html" class="">Print</a></li></ul></li> <li><a href="/comms-platform/docs/rest-api.html" class="">REST API</a></li> <li><a href="/comms-platform/docs/channels.html" class="">Channels</a></li> <li><a href="/comms-platform/docs/feedback.html" class="">Feedback</a></li> <li><a href="/comms-platform/docs/scheduling.html" class="">Scheduling</a></li> <li><a href="/comms-platform/docs/events.html" class=" active ">Events</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="hidden-xs"><a href="https://github.com/ovotech/comms-platform"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li class="hidden-xs"><a href="https://github.com/ovotech/comms-platform"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('OVO Comms Platform comms-platform');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('OVO Comms Platform comms-platform');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="ovotech" data-github-repo="comms-platform"><div class="content-wrapper"><section><h1 id="events">Events</h1>

<div class="alert alert-danger">
    Please note that triggering communications via Kafka events is deprecated.
</div>

<p>Communications can be triggered via our REST API, find out more <a href="rest-api.html">here</a></p>

<h2 id="triggeredv3">TriggeredV3</h2>

<p>In order to send a comm to a customer, you need to trigger the comm by sending a <code class="highlighter-rouge">TriggeredV3</code> event to the <code class="highlighter-rouge">comms.triggered.v3</code> Kafka topic.</p>

<h3 id="event-structure">Event structure</h3>

<p>The <code class="highlighter-rouge">TriggeredV3</code> event has the following fields:</p>

<ul>
  <li><code class="highlighter-rouge">metadata</code> - This includes a unique ID for the comm and a DeliverTo (either the ID of the customer you wish to send the given comm to, or the contact details if the comm recipient does not have a Salesforce account). Note this also includes a canary flag which is solely for internal use by the comms team, setting this flag to true will result in the comm not being delivered to the specified recipient so please ensure this is set to false. The fields are documented in the <a href="https://github.com/ovotech/comms-kafka-messages/blob/master/modules/core/src/main/scala/com/ovoenergy/comms/model/MetadataV2.scala">source code</a> and in the Avro schema (available in the schema registry).</li>
  <li><code class="highlighter-rouge">templateData</code> - This is the customer-specific data you want to use to fill in the placeholders in your comm template. <strong>Note:</strong> If you fail to fill in all the placeholders in the template, your comm will not be sent!</li>
  <li><code class="highlighter-rouge">deliverAt</code> (optional) - If you want to schedule the comm to be sent in the future, use this field to specify the delivery time. See the <a href="scheduling.html">scheduling</a> page for more details.</li>
  <li><code class="highlighter-rouge">expireAt</code> (optional) - If your comm is time sensitive, you can use this field to specify the latest delivery time. See the <a href="scheduling.html">scheduling</a> page for more details.</li>
  <li><code class="highlighter-rouge">preferredChannels</code> (optional) - An ordered list of channels over which you would like to send the comm. See the <a href="channels.html">channels</a> page for more details.</li>
</ul>

<h3 id="deliverto---customer-vs-non-customer-comms">DeliverTo - customer vs non-customer comms</h3>

<p>As part of the metadata, you need to specify the <code class="highlighter-rouge">deliverTo</code> field. In case of SMS and email, you can provide either as <code class="highlighter-rouge">Customer</code> or <code class="highlighter-rouge">ContactDetails</code>, for print deliverTo must be a <code class="highlighter-rouge">ContactDetails</code> field:</p>

<ul>
  <li>A <code class="highlighter-rouge">Customer</code>, containing a global customer ID, if you want to send the comm to an OVO customer. Currently not available for print.</li>
  <li>A <code class="highlighter-rouge">ContactDetails</code>, if you want to send the comm to an arbitrary recipient. You must provide details of at least one of the three channels.</li>
</ul>

<p>As customers cannot be referenced by the global customer ID for print templates, if required any additional information about the customer, such as first name, last name, it has to be included in the template data.</p>

<h3 id="building-the-event">Building the event</h3>

<p>As long as you send us a valid <code class="highlighter-rouge">TriggeredV3</code> event, you can build it however you like.</p>

<p>However, if you are using Scala, we recommend you use our <code class="highlighter-rouge">comms-triggered-event-builder</code> library. This will generate Scala classes corresponding to the structure of your comm template, giving you a compile-time guarantee that you have filled in the template correctly.</p>

<p>For example, say you have the following comm template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Please give us your meter reads.

{{#if gas}}
  We need reads for the following gas meters:

  {{#each gas.meters}}
   - {{this.meterNumber}}  
  {{/each}}
{{/if}}

{{#if electricity}}
  We need reads for the following electricity meters:

  {{#each electricity.meters}}
  - {{this.firstNumber}} {{this.secondNumber}}  
  {{/each}}
{{/if}}
</code></pre></div></div>

<p>You can generate a case class corresponding to this template using a macro annotation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.ovoenergy.comms.triggered.Template</span>

<span class="nd">@Template</span><span class="o">(</span><span class="s">"service"</span><span class="o">,</span> <span class="s">"example-for-docs"</span><span class="o">,</span> <span class="s">"0.1"</span><span class="o">)</span>
<span class="k">object</span> <span class="nc">MeterReadsComm</span>
</code></pre></div></div>

<p>This will generate a case class with the same name as the annotated object.</p>

<p>You can then build an instance of the generated case class. Note how it matches the structure of the template:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">MeterReadsComm</span><span class="o">(</span>
  <span class="n">gas</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span> <span class="c1">// not a gas customer
</span>	<span class="n">electricity</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">MeterReadsComm</span><span class="o">.</span><span class="nc">Electricity</span><span class="o">(</span>
		<span class="n">meters</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
			<span class="c1">// customer has 2 electricity meters
</span>			<span class="nc">MeterReadsComm</span><span class="o">.</span><span class="nc">Electricity</span><span class="o">.</span><span class="nc">Meter</span><span class="o">(</span><span class="n">firstNumber</span> <span class="k">=</span> <span class="s">"123"</span><span class="o">,</span> <span class="n">secondNumber</span> <span class="k">=</span> <span class="s">"456"</span><span class="o">),</span>
			<span class="nc">MeterReadsComm</span><span class="o">.</span><span class="nc">Electricity</span><span class="o">.</span><span class="nc">Meter</span><span class="o">(</span><span class="n">firstNumber</span> <span class="k">=</span> <span class="s">"789"</span><span class="o">,</span> <span class="n">secondNumber</span> <span class="k">=</span> <span class="s">"123"</span><span class="o">)</span>
		<span class="o">)</span>
	<span class="o">))</span>
<span class="o">)</span>
</code></pre></div></div>

<p>You can then convert it into the appropriate format for inclusion in a <code class="highlighter-rouge">TriggeredV3</code> event:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.ovoenergy.comms.model.TemplateData</span>

<span class="k">val</span> <span class="n">templateData</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">TemplateData</span><span class="o">]</span> <span class="k">=</span> <span class="n">data</span><span class="o">.</span><span class="n">convertToTemplateData</span>
</code></pre></div></div>

<p>Now you’re ready to build an event:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.ovoenergy.comms.model.</span><span class="o">{</span><span class="nc">MetadataV2</span><span class="o">,</span> <span class="nc">TriggeredV3</span><span class="o">,</span> <span class="nc">Customer</span><span class="o">}</span>
<span class="k">val</span> <span class="n">metadata</span> <span class="k">=</span> <span class="nc">MetadataV2</span><span class="o">(</span>
	<span class="n">createdAt</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="nc">Instant</span><span class="o">.</span><span class="n">now</span><span class="o">(),</span>
	<span class="n">eventId</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">().</span><span class="n">toString</span><span class="o">,</span>
	<span class="n">traceToken</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">().</span><span class="n">toString</span><span class="o">,</span>
	<span class="n">deliverTo</span> <span class="k">=</span> <span class="nc">Customer</span><span class="o">(</span><span class="s">"my-customer"</span><span class="o">),</span> 
	<span class="n">commManifest</span> <span class="k">=</span> <span class="nc">MeterReadsComm</span><span class="o">.</span><span class="n">commManifest</span><span class="o">,</span> <span class="c1">// use the generated comm manifest in the companion object
</span>	<span class="n">friendlyDescription</span> <span class="k">=</span> <span class="s">"awesome comm"</span><span class="o">,</span>
	<span class="n">source</span> <span class="k">=</span> <span class="s">"my amazing service"</span><span class="o">,</span>
	<span class="n">triggerSource</span> <span class="k">=</span> <span class="s">"my amazing service"</span><span class="o">,</span>
	<span class="n">canary</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span>
	<span class="n">sourceMetadata</span> <span class="k">=</span> <span class="nc">None</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">event</span> <span class="k">=</span> <span class="nc">TriggeredV3</span><span class="o">(</span>
  <span class="n">metadata</span> <span class="k">=</span> <span class="n">metadata</span><span class="o">,</span> 
  <span class="n">templateData</span> <span class="k">=</span> <span class="n">templateData</span><span class="o">,</span> 
  <span class="n">deliverAt</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span> 
  <span class="n">expireAt</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span> 
  <span class="n">preferredChannels</span> <span class="k">=</span> <span class="nc">None</span>
<span class="o">)</span>
</code></pre></div></div>

<h4 id="viewing-the-generated-code">Viewing the generated code</h4>

<p>The macro will print a slightly simplified version of the generated code to standard out when you compile, so you can see the structure of the generated model classes.</p>

<p>The output should look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Based on your comm template, the following code has been generated:

object CanaryTemplateData {
  val commManifest: CommManifest = CommManifest(CommType.Service, "canary", "2.0")
  case class Thing(word: String) { ... }
}
case class CanaryTemplateData(traceToken: String, optionalString: Option[String], things: Seq[CanaryTemplateData.Thing]) { ... }

Use these classes to construct an instance of CanaryTemplateData, then call its `convertToTemplateData`
to create a `Map[String, TemplateData]` suitable for use in a `TriggeredV3` event.
</code></pre></div></div>

<h4 id="a-note-about-intellij-support">A note about IntelliJ support</h4>

<p>Because our annotation uses a scala.meta macro to generate code at compile time, IntelliJ gets quite confused.</p>

<p>Autocomplete will not work, and your code will look like it doesn’t compile:</p>

<p><img src="../img/intellij-sea-of-red.png" alt="IntelliJ is a sea of red" /></p>

<p>Rest assured that your code will compile just fine with sbt.</p>

<p>If you are using IntelliJ 2017.1 or newer, there will be a little icon next to the annotation:</p>

<p><img src="../img/intellij-expand-macro.png" alt="IntelliJ: expand scala.meta macro" /></p>

<p>Clicking this will expand the annotation, replacing the annotated object with the generated code. This means you can see exactly what the generated code looks like, and will also allow IntelliJ to understand it.</p>

<p>However, we recommend that you un-expand the macro again afterwards (currently the only way to do this in IntelliJ is to “Undo”), and avoid committing the generated code to git.</p>

<h3 id="sending-the-event">Sending the event</h3>

<p>Events should be sent using the Kafka cluster on Aiven.</p>

<p>All events must be encoded as Avro binary, with the schema ID in a header. The Avro schemas are all registered in the schema registry on Aiven.</p>

<p>If you are using Scala, we recommend that you use our <a href="https://github.com/ovotech/comms-kafka-serialisation"><code class="highlighter-rouge">comms-kafka-serialisation</code></a> library to help you encode the event as Avro binary:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.ovoenergy.comms.serialisation.Serialisation.avroBinarySchemaRegistrySerializer</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.comms.serialisation.Codecs._</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.kafka.serialization.avro.SchemaRegistryClientSettings</span>

<span class="k">val</span> <span class="n">schemaRegistryUrl</span> <span class="k">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">(</span><span class="s">"SCHEMA_REGISTRY_URL"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">schemaRegistryUsername</span> <span class="k">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">(</span><span class="s">"SCHEMA_REGISTRY_USERNAME"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">schemaRegistryPassword</span> <span class="k">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">(</span><span class="s">"SCHEMA_REGISTRY_PASSWORD"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">schemaRegistryClientSettings</span> <span class="k">=</span> <span class="nc">SchemaRegistryClientSettings</span><span class="o">(</span><span class="n">schemaRegistryUrl</span><span class="o">,</span> <span class="n">schemaRegistryUsername</span><span class="o">,</span> <span class="n">schemaRegistryPassword</span><span class="o">)</span>

<span class="k">val</span> <span class="n">serializer</span> <span class="k">=</span> <span class="n">avroBinarySchemaRegistrySerializer</span><span class="o">[</span><span class="kt">TriggeredV3</span><span class="o">](</span><span class="n">schemaRegistryClientSettings</span><span class="o">,</span> <span class="s">"comms.triggered.v3"</span><span class="o">)</span>

<span class="k">val</span> <span class="n">bytes</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span> <span class="k">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">serialize</span><span class="o">(</span><span class="s">"comms.triggered.v3"</span><span class="o">,</span> <span class="n">event</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="example-project">Example project</h2>

<p>We have a full working example project showing the recommended way to build and send a <code class="highlighter-rouge">TriggeredV3</code> event in Scala: <a href="https://github.com/ovotech/comms-example-trigger">https://github.com/ovotech/comms-example-trigger</a></p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/comms-platform/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/comms-platform/js/main.js"></script></body></html>